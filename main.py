import StringIO
import json
import logging
import random
import urllib
import urllib2
import re

import random
# standard app engine imports
from google.appengine.api import urlfetch
from google.appengine.ext import ndb
import webapp2

TOKEN = '117344370:AAHHCNDsY6DGWdFBDNnk4e-KSVwXGOH09xU'

BASE_URL = 'https://api.telegram.org/bot' + TOKEN + '/'

DIGITS = '0123456789'
SIZE = 4

# ================================

class EnableStatus(ndb.Model):
    # key name: str(chat_id)
    enabled = ndb.BooleanProperty(indexed=False, default=False)

# ================================

def setEnabled(chat_id, yes):
    es = EnableStatus.get_or_insert(str(chat_id))
    es.enabled = yes
    es.put()

def getEnabled(chat_id):
    es = EnableStatus.get_by_id(str(chat_id))
    if es:
        return es.enabled
    return True
    #return False


# ================================


class ChatData(ndb.Model):
    num = ndb.StringProperty()
    numattempts = ndb.IntegerProperty()
    user = ndb.StringProperty()
    games = ndb.IntegerProperty()
    best = ndb.IntegerProperty()
    guesshistory = ndb.StringProperty()

def updateCD(chat_id, num, numattempts, games, user, best, history):
    cb = ChatData.get_or_insert(str(chat_id))
    cb.num = num
    cb.numattempts = numattempts
    cb.games = games
    cb.user = user
    cb.best = best
    cb.guesshistory = history
    cb.put()

def getCD(chat_id, name):
    cb = ChatData.get_by_id(str(chat_id))
    if cb:
        return cb
    else:
        cb = ChatData.get_or_insert(str(chat_id))
        cb.num = ''.join([random.choice(DIGITS) for _ in range(SIZE)])
        cb.numattempts = 0
        cb.games = 1
        cb.user = name
        cb.best = 0
        cb.guesshistory = ""
        cb.put()
        return cb



class MeTester(webapp2.RequestHandler):
    def get(self):
        urlfetch.set_default_fetch_deadline(60)
        self.response.write('yolo')

class MeHandler(webapp2.RequestHandler):
    def get(self):
        urlfetch.set_default_fetch_deadline(60)
        self.response.write(json.dumps(json.load(urllib2.urlopen(BASE_URL + 'getMe'))))


class GetUpdatesHandler(webapp2.RequestHandler):
    def get(self):
        urlfetch.set_default_fetch_deadline(60)
        self.response.write(json.dumps(json.load(urllib2.urlopen(BASE_URL + 'getUpdates'))))


class SetWebhookHandler(webapp2.RequestHandler):
    def get(self):
        urlfetch.set_default_fetch_deadline(60)
        url = self.request.get('url')
        if url:
            self.response.write(json.dumps(json.load(urllib2.urlopen(BASE_URL + 'setWebhook', urllib.urlencode({'url': url})))))


class WebhookHandler(webapp2.RequestHandler):
    def post(self):
        urlfetch.set_default_fetch_deadline(60)
        body = json.loads(self.request.body)
        logging.info('request body:')
        logging.info(body)
        self.response.write(json.dumps(body))

        qb = body.get('callback_query')
        if(qb):
            text = qb.get('message').get('text')
            if "left" in qb.get('data'):
                x = -1
            else:
                x = 1
            try:
                newtext = str(int(text)+x)
            except:
                newtext = 0
            inline_keyboard = {'inline_keyboard': [[{'text':'Left', 'callback_data': 'left'},{'text':'Right', 'callback_data': 'right'}]]}
            inline_keyboard = json.dumps(inline_keyboard)
            params = urllib.urlencode({
                'chat_id': str(qb.get('message').get('chat').get('id')),
                'text': newtext,
                'message_id': str(qb.get('message').get('message_id')),
                'reply_markup': inline_keyboard,
                'disable_web_page_preview': 'true'
            })
            a = urllib.urlopen(BASE_URL+'editMessageText?'+params)
            logging.info(a.read())
            return
            
        try:
            update_id = body['update_id']
            message = body['message']
            message_id = message.get('message_id')
            date = message.get('date')
            text = message.get('text')
            fr = message.get('from')
            chat = message['chat']
            chat_id = chat['id']

            if not text:
                logging.info('no text')
                return
        except Exception as e:
            logging.error(e)


        emlist = 'ðŸ˜€ðŸ˜¬ðŸ˜ðŸ˜‚ðŸ˜ƒðŸ˜„ðŸ˜…ðŸ˜†ðŸ˜‡ðŸ˜‰ðŸ˜ŠðŸ™‚ðŸ™ƒâ˜ºï¸ðŸ˜‹ðŸ˜ŒðŸ˜ðŸ˜˜ðŸ˜—ðŸ˜™ðŸ˜šðŸ˜œðŸ˜ðŸ˜›ðŸ¤‘ðŸ¤“ðŸ˜ŽðŸ¤—ðŸ˜ðŸ˜¶ðŸ˜ðŸ˜‘ðŸ˜’ðŸ™„ðŸ¤”ðŸ˜³ðŸ˜žðŸ˜ŸðŸ˜ ðŸ˜¡ðŸ˜”ðŸ˜•ðŸ™â˜¹ï¸ðŸ˜£ðŸ˜–ðŸ˜«ðŸ˜©ðŸ˜¤ðŸ˜®ðŸ˜±ðŸ˜¨ðŸ˜°ðŸ˜¯ðŸ˜¦ðŸ˜§ðŸ˜¢ðŸ˜¥ðŸ˜ªðŸ˜“ðŸ˜­ðŸ˜µðŸ˜²ðŸ¤ðŸ˜·ðŸ¤’ðŸ¤•ðŸ˜´ðŸ’¤ðŸ’©ðŸ˜ˆðŸ‘¿ðŸ‘¹ðŸ‘ºðŸ’€ðŸ‘»ðŸ‘½ðŸ¤–ðŸ˜ºðŸ˜¸ðŸ˜¹ðŸ˜»ðŸ˜¼ðŸ˜½ðŸ™€ðŸ˜¿ðŸ˜¾ðŸ™ŒðŸ‘ðŸ‘‹ðŸ‘ðŸ‘ŠâœŠâœŒðŸ‘Œâœ‹ðŸ’ªðŸ™â˜ï¸ðŸ‘†ðŸ‘‡ðŸ‘ˆðŸ‘‰ðŸ–•ðŸ¤˜ðŸ––âœðŸ’…ðŸ‘„ðŸ‘…ðŸ‘‚ðŸ‘ƒðŸ‘ðŸ‘€ðŸ‘¤ðŸ—£ðŸ‘¶ðŸ‘¦ðŸ‘§ðŸ‘¨ðŸ‘©ðŸ‘±ðŸ‘´ðŸ‘µðŸ‘²ðŸ‘³ðŸ‘®ðŸ‘·ðŸ’‚ðŸ•µðŸŽ…ðŸ‘¼ðŸ‘¸ðŸ‘°ðŸš¶ðŸƒðŸ’ƒðŸ‘¯ðŸ‘«ðŸ‘¬ðŸ‘­ðŸ™‡ðŸ’ðŸ™…ðŸ™†ðŸ™‹ðŸ™ŽðŸ™ðŸ’‡ðŸ’†ðŸ’‘ðŸ‘©â€â¤ï¸â€ðŸ‘©ðŸ‘¨â€â¤ï¸â€ðŸ‘¨ðŸ’ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘©ðŸ‘¨â€â¤ï¸â€ðŸ’‹â€ðŸ‘¨ðŸ‘ªðŸ‘¨â€ðŸ‘©â€ðŸ‘§ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§ðŸ‘©â€ðŸ‘©â€ðŸ‘¦ðŸ‘©â€ðŸ‘©â€ðŸ‘§ðŸ‘©â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ðŸ‘©â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦ðŸ‘©â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘¦ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘§ðŸ‘šðŸ‘•ðŸ‘–ðŸ‘”ðŸ‘—ðŸ‘™ðŸ‘˜ðŸ’„ðŸ’‹ðŸ‘£ðŸ‘ ðŸ‘¡ðŸ‘¢ðŸ‘žðŸ‘ŸðŸ‘’ðŸŽ©â›‘ðŸŽ“ðŸ‘‘ðŸŽ’ðŸ‘ðŸ‘›ðŸ‘œðŸ’¼ðŸ‘“ðŸ•¶ðŸ’ðŸŒ‚ðŸ‘¦ðŸ»ðŸ‘§ðŸ»ðŸ‘¨ðŸ»ðŸ‘©ðŸ»ðŸ‘´ðŸ»ðŸ‘µðŸ»ðŸ‘¶ðŸ»ðŸ‘±ðŸ»ðŸ‘®ðŸ»ðŸ‘²ðŸ»ðŸ‘³ðŸ»ðŸ‘·ðŸ»ðŸ‘¸ðŸ»ðŸ’‚ðŸ»ðŸŽ…ðŸ»ðŸ‘¼ðŸ»ðŸ’†ðŸ»ðŸ’‡ðŸ»ðŸ‘°ðŸ»ðŸ™ðŸ»ðŸ™ŽðŸ»ðŸ™…ðŸ»ðŸ™†ðŸ»ðŸ’ðŸ»ðŸ™‹ðŸ»ðŸ™‡ðŸ»ðŸ™ŒðŸ»ðŸ™ðŸ»ðŸš¶ðŸ»ðŸƒðŸ»ðŸ’ƒðŸ»ðŸ’ªðŸ»ðŸ‘ˆðŸ»ðŸ‘‰ðŸ»â˜ðŸ»ï¸ðŸ‘†ðŸ»ðŸ–•ðŸ»ðŸ‘‡ðŸ»âœŒðŸ»ðŸ––ðŸ»ðŸ¤˜ðŸ»ðŸ–ðŸ»âœŠðŸ»âœ‹ðŸ»ðŸ‘ŠðŸ»ðŸ‘ŒðŸ»ðŸ‘ðŸ»ðŸ‘ŽðŸ»ðŸ‘‹ðŸ»ðŸ‘ðŸ»ðŸ‘ðŸ»âœðŸ»ðŸ’…ðŸ»ðŸ‘‚ðŸ»ðŸ‘ƒðŸ»ðŸš£ðŸ»ðŸ›€ðŸ»ðŸ„ðŸ»ðŸ‡ðŸ»ðŸŠðŸ»â›¹ðŸ»ðŸ‹ðŸ»ðŸš´ðŸ»ðŸšµðŸ»ðŸ‘¦ðŸ¼ðŸ‘§ðŸ¼ðŸ‘¨ðŸ¼ðŸ‘©ðŸ¼ðŸ‘´ðŸ¼ðŸ‘µðŸ¼ðŸ‘¶ðŸ¼ðŸ‘±ðŸ¼ðŸ‘®ðŸ¼ðŸ‘²ðŸ¼ðŸ‘³ðŸ¼ðŸ‘·ðŸ¼ðŸ‘¸ðŸ¼ðŸ’‚ðŸ¼ðŸŽ…ðŸ¼ðŸ‘¼ðŸ¼ðŸ’†ðŸ¼ðŸ’‡ðŸ¼ðŸ‘°ðŸ¼ðŸ™ðŸ¼ðŸ™ŽðŸ¼ðŸ™…ðŸ¼ðŸ™†ðŸ¼ðŸ’ðŸ¼ðŸ™‹ðŸ¼ðŸ™‡ðŸ¼ðŸ™ŒðŸ¼ðŸ™ðŸ¼ðŸš¶ðŸ¼ðŸƒðŸ¼ðŸ’ƒðŸ¼ðŸ’ªðŸ¼ðŸ‘ˆðŸ¼ðŸ‘‰ðŸ¼â˜ðŸ¼ï¸ðŸ‘†ðŸ¼ðŸ–•ðŸ¼ðŸ‘‡ðŸ¼âœŒðŸ¼ðŸ––ðŸ¼ðŸ¤˜ðŸ¼ðŸ–ðŸ¼âœŠðŸ¼âœ‹ðŸ¼ðŸ‘ŠðŸ¼ðŸ‘ŒðŸ¼ðŸ‘ðŸ¼ðŸ‘ŽðŸ¼ðŸ‘‹ðŸ¼ðŸ‘ðŸ¼ðŸ‘ðŸ¼âœðŸ¼ðŸ’…ðŸ¼ðŸ‘‚ðŸ¼ðŸ‘ƒðŸ¼ðŸš£ðŸ¼ðŸ›€ðŸ¼ðŸ„ðŸ¼ðŸ‡ðŸ¼ðŸŠðŸ¼â›¹ðŸ¼ðŸ‹ðŸ¼ðŸš´ðŸ¼ðŸšµðŸ¼ðŸ‘¦ðŸ½ðŸ‘§ðŸ½ðŸ‘¨ðŸ½ðŸ‘©ðŸ½ðŸ‘´ðŸ½ðŸ‘µðŸ½ðŸ‘¶ðŸ½ðŸ‘±ðŸ½ðŸ‘®ðŸ½ðŸ‘²ðŸ½ðŸ‘³ðŸ½ðŸ‘·ðŸ½ðŸ‘¸ðŸ½ðŸ’‚ðŸ½ðŸŽ…ðŸ½ðŸ‘¼ðŸ½ðŸ’†ðŸ½ðŸ’‡ðŸ½ðŸ‘°ðŸ½ðŸ™ðŸ½ðŸ™ŽðŸ½ðŸ™…ðŸ½ðŸ™†ðŸ½ðŸ’ðŸ½ðŸ™‹ðŸ½ðŸ™‡ðŸ½ðŸ™ŒðŸ½ðŸ™ðŸ½ðŸš¶ðŸ½ðŸƒðŸ½ðŸ’ƒðŸ½ðŸ’ªðŸ½ðŸ‘ˆðŸ½ðŸ‘‰ðŸ½â˜ðŸ½ï¸ðŸ‘†ðŸ½ðŸ–•ðŸ½ðŸ‘‡ðŸ½âœŒðŸ½ðŸ––ðŸ½ðŸ¤˜ðŸ½ðŸ–ðŸ½âœŠðŸ½âœ‹ðŸ½ðŸ‘ŠðŸ½ðŸ‘ŒðŸ½ðŸ‘ðŸ½ðŸ‘ŽðŸ½ðŸ‘‹ðŸ½ðŸ‘ðŸ½ðŸ‘ðŸ½âœðŸ½ðŸ’…ðŸ½ðŸ‘‚ðŸ½ðŸ‘ƒðŸ½ðŸš£ðŸ½ðŸ›€ðŸ½ðŸ„ðŸ½ðŸ‡ðŸ½ðŸŠðŸ½â›¹ðŸ½ðŸ‹ðŸ½ðŸš´ðŸ½ðŸšµðŸ½ðŸ‘¦ðŸ¾ðŸ‘§ðŸ¾ðŸ‘¨ðŸ¾ðŸ‘©ðŸ¾ðŸ‘´ðŸ¾ðŸ‘µðŸ¾ðŸ‘¶ðŸ¾ðŸ‘±ðŸ¾ðŸ‘®ðŸ¾ðŸ‘²ðŸ¾ðŸ‘³ðŸ¾ðŸ‘·ðŸ¾ðŸ‘¸ðŸ¾ðŸ’‚ðŸ¾ðŸŽ…ðŸ¾ðŸ‘¼ðŸ¾ðŸ’†ðŸ¾ðŸ’‡ðŸ¾ðŸ‘°ðŸ¾ðŸ™ðŸ¾ðŸ™ŽðŸ¾ðŸ™…ðŸ¾ðŸ™†ðŸ¾ðŸ’ðŸ¾ðŸ™‹ðŸ¾ðŸ™‡ðŸ¾ðŸ™ŒðŸ¾ðŸ™ðŸ¾ðŸš¶ðŸ¾ðŸƒðŸ¾ðŸ’ƒðŸ¾ðŸ’ªðŸ¾ðŸ‘ˆðŸ¾ðŸ‘‰ðŸ¾â˜ðŸ¾ï¸ðŸ‘†ðŸ¾ðŸ–•ðŸ¾ðŸ‘‡ðŸ¾âœŒðŸ¾ðŸ––ðŸ¾ðŸ¤˜ðŸ¾ðŸ–ðŸ¾âœŠðŸ¾âœ‹ðŸ¾ðŸ‘ŠðŸ¾ðŸ‘ŒðŸ¾ðŸ‘ðŸ¾ðŸ‘ŽðŸ¾ðŸ‘‹ðŸ¾ðŸ‘ðŸ¾ðŸ‘ðŸ¾âœðŸ¾ðŸ’…ðŸ¾ðŸ‘‚ðŸ¾ðŸ‘ƒðŸ¾ðŸš£ðŸ¾ðŸ›€ðŸ¾ðŸ„ðŸ¾ðŸ‡ðŸ¾ðŸŠðŸ¾â›¹ðŸ¾ðŸ‹ðŸ¾ðŸš´ðŸ¾ðŸšµðŸ¾ðŸ‘¦ðŸ¿ðŸ‘§ðŸ¿ðŸ‘¨ðŸ¿ðŸ‘©ðŸ¿ðŸ‘´ðŸ¿ðŸ‘µðŸ¿ðŸ‘¶ðŸ¿ðŸ‘±ðŸ¿ðŸ‘®ðŸ¿ðŸ‘²ðŸ¿ðŸ‘³ðŸ¿ðŸ‘·ðŸ¿ðŸ‘¸ðŸ¿ðŸ’‚ðŸ¿ðŸŽ…ðŸ¿ðŸ‘¼ðŸ¿ðŸ’†ðŸ¿ðŸ’‡ðŸ¿ðŸ‘°ðŸ¿ðŸ™ðŸ¿ðŸ™ŽðŸ¿ðŸ™…ðŸ¿ðŸ™†ðŸ¿ðŸ’ðŸ¿ðŸ™‹ðŸ¿ðŸ™‡ðŸ¿ðŸ™ŒðŸ¿ðŸ™ðŸ¿ðŸš¶ðŸ¿ðŸƒðŸ¿ðŸ’ƒðŸ¿ðŸ’ªðŸ¿ðŸ‘ˆðŸ¿ðŸ‘‰ðŸ¿â˜ðŸ¿ï¸ðŸ‘†ðŸ¿ðŸ–•ðŸ¿ðŸ‘‡ðŸ¿âœŒðŸ¿ðŸ––ðŸ¿ðŸ¤˜ðŸ¿ðŸ–ðŸ¿âœŠðŸ¿âœ‹ðŸ¿ðŸ‘ŠðŸ¿ðŸ‘ŒðŸ¿ðŸ‘ðŸ¿ðŸ‘ŽðŸ¿ðŸ‘‹ðŸ¿ðŸ‘ðŸ¿ðŸ‘ðŸ¿âœðŸ¿ðŸ’…ðŸ¿ðŸ‘‚ðŸ¿ðŸ‘ƒðŸ¿ðŸš£ðŸ¿ðŸ›€ðŸ¿ðŸ„ðŸ¿ðŸ‡ðŸ¿ðŸŠðŸ¿â›¹ðŸ¿ðŸ‹ðŸ¿ðŸš´ðŸ¿ðŸšµðŸ¿ðŸ¶ðŸ±ðŸ­ðŸ¹ðŸ°ðŸ»ðŸ¼ðŸ¨ðŸ¯ðŸ¦ðŸ®ðŸ·ðŸ½ðŸ¸ðŸ™ðŸµðŸ™ˆðŸ™‰ðŸ™ŠðŸ’ðŸ”ðŸ§ðŸ¦ðŸ¤ðŸ£ðŸ¥ðŸºðŸ—ðŸ´ðŸ¦„ðŸðŸ›ðŸŒðŸžðŸœðŸ•·ðŸ¦‚ðŸ¦€ðŸðŸ¢ðŸ ðŸŸðŸ¡ðŸ¬ðŸ³ðŸ‹ðŸŠðŸ†ðŸ…ðŸƒðŸ‚ðŸ„ðŸªðŸ«ðŸ˜ðŸðŸðŸ‘ðŸŽðŸ–ðŸ€ðŸðŸ“ðŸ¦ƒðŸ•ŠðŸ•ðŸ©ðŸˆðŸ‡ðŸ¿ðŸ¾ðŸ‰ðŸ²ðŸŒµðŸŽ„ðŸŒ²ðŸŒ³ðŸŒ´ðŸŒ±ðŸŒ¿â˜˜ðŸ€ðŸŽðŸŽ‹ðŸƒðŸ‚ðŸðŸŒ¾ðŸŒºðŸŒ»ðŸŒ¹ðŸŒ·ðŸŒ¼ðŸŒ¸ðŸ’ðŸ„ðŸŒ°ðŸŽƒðŸšðŸ•¸ðŸŒŽðŸŒðŸŒðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒšðŸŒðŸŒ›ðŸŒœðŸŒžðŸŒ™â­ï¸ðŸŒŸðŸ’«âœ¨â˜„â˜€ï¸ðŸŒ¤â›…ï¸ðŸŒ¥ðŸŒ¦â˜ï¸ðŸŒ§â›ˆðŸŒ©âš¡ï¸ðŸ”¥ðŸ’¥â„ï¸ðŸŒ¨ðŸ”¥ðŸ’¥â„ï¸ðŸŒ¨â˜ƒâ›„ï¸ðŸŒ¬ðŸ’¨ðŸŒªðŸŒ«â˜‚â˜”ï¸ðŸ’§ðŸ’¦ðŸŒŠðŸðŸŽðŸðŸŠðŸ‹ðŸŒðŸ‰ðŸ‡ðŸ“ðŸˆðŸ’ðŸ‘ðŸðŸ…ðŸ†ðŸŒ¶ðŸŒ½ðŸ ðŸ¯ðŸžðŸ§€ðŸ—ðŸ–ðŸ¤ðŸ³ðŸ”ðŸŸðŸŒ­ðŸ•ðŸðŸŒ®ðŸŒ¯ðŸœðŸ²ðŸ¥ðŸ£ðŸ±ðŸ›ðŸ™ðŸšðŸ˜ðŸ¢ðŸ¡ðŸ§ðŸ¨ðŸ¦ðŸ°ðŸŽ‚ðŸ®ðŸ¬ðŸ­ðŸ«ðŸ¿ðŸ©ðŸªðŸºðŸ»ðŸ·ðŸ¸ðŸ¹ðŸ¾ðŸ¶ðŸµâ˜•ï¸ðŸ¼ðŸ´ðŸ½âš½ï¸ðŸ€ðŸˆâš¾ï¸ðŸŽ¾ðŸðŸ‰ðŸŽ±â›³ï¸ðŸŒðŸ“ðŸ¸ðŸ’ðŸ‘ðŸðŸŽ¿â›·ðŸ‚â›¸ðŸ¹ðŸŽ£ðŸš£ðŸŠðŸ„ðŸ›€â›¹ðŸ‹ðŸš´ðŸšµðŸ‡ðŸ•´ðŸ†ðŸŽ½ðŸ…ðŸŽ–ðŸŽ—ðŸµðŸŽ«ðŸŽŸðŸŽ­ðŸŽ¨ðŸŽªðŸŽ¤ðŸŽ§ðŸŽ¼ðŸŽ¹ðŸŽ·ðŸŽºðŸŽ¸ðŸŽ»ðŸŽ¬ðŸŽ®ðŸ‘¾ðŸŽ¯ðŸŽ²ðŸŽ°ðŸŽ³ðŸš—ðŸš•ðŸš™ðŸšŒðŸšŽðŸŽðŸš“ðŸš‘ðŸš’ðŸšðŸššðŸš›ðŸšœðŸðŸš²ðŸš¨ðŸš”ðŸšðŸš˜ðŸš–ðŸš¡ðŸš ðŸšŸðŸšƒðŸš‹ðŸšðŸš„ðŸš…ðŸšˆðŸšžðŸš‚ðŸš†ðŸš‡ðŸšŠðŸš‰ðŸšðŸ›©âœˆï¸ðŸ›«ðŸ›¬â›µï¸ðŸ›¥ðŸš¤â›´ðŸ›³ðŸš€ðŸ›°ðŸ’ºâš“ï¸ðŸš§â›½ï¸ðŸšðŸš¦ðŸš¥ðŸðŸš¢ðŸŽ¡ðŸŽ¢ðŸŽ ðŸ—ðŸŒðŸ—¼ðŸ­â›²ï¸ðŸŽ‘â›°ðŸ”ðŸ—»ðŸŒ‹ðŸ—¾ðŸ•â›ºï¸ðŸžðŸ›£ðŸ›¤ðŸŒ…ðŸŒ„ðŸœðŸ–ðŸðŸŒ‡ðŸŒ†ðŸ™ðŸŒƒðŸŒ‰ðŸŒŒðŸŒ ðŸŽ‡ðŸŽ†ðŸŒˆðŸ˜ðŸ°ðŸ¯ðŸŸðŸ—½ðŸ ðŸ¡ðŸšðŸ¢ðŸ¬ðŸ£ðŸ¤ðŸ¥ðŸ¦ðŸ¨ðŸªðŸ«ðŸ©ðŸ’’ðŸ›â›ªï¸ðŸ•ŒðŸ•ðŸ•‹â›©âŒšï¸ðŸ“±ðŸ“²ðŸ’»âŒ¨ðŸ–¥ðŸ–¨ðŸ–±ðŸ–²ðŸ•¹ðŸ—œðŸ’½ðŸ’¾ðŸ’¿ðŸ“€ðŸ“¼ðŸ“·ðŸ“¸ðŸ“¹ðŸŽ¥ðŸ“½ðŸŽžðŸ“žâ˜Žï¸ðŸ“ŸðŸ“ ðŸ“ºðŸ“»ðŸŽ™ðŸŽšðŸŽ›â±â²â°ðŸ•°â³âŒ›ï¸ðŸ“¡ðŸ”‹ðŸ”ŒðŸ’¡ðŸ”¦ðŸ•¯ðŸ—‘ðŸ›¢ðŸ’¸ðŸ’µðŸ’´ðŸ’¶ðŸ’·ðŸ’°ðŸ’³ðŸ’Žâš–ðŸ”§ðŸ”¨âš’ðŸ› â›ðŸ”©âš™â›“ðŸ”«ðŸ’£ðŸ”ªðŸ—¡âš”ðŸ›¡ðŸš¬â˜ âš°âš±ðŸºðŸ”®ðŸ“¿ðŸ’ˆâš—ðŸ”­ðŸ”¬ðŸ•³ðŸ’ŠðŸ’‰ðŸŒ¡ðŸ·ðŸ”–ðŸš½ðŸš¿ðŸ›ðŸ”‘ðŸ—ðŸ›‹ðŸ›ŒðŸ›ðŸšªðŸ›ŽðŸ–¼ðŸ—ºâ›±ðŸ—¿ðŸ›ðŸŽˆðŸŽðŸŽ€ðŸŽðŸŽŠðŸŽ‰ðŸŽŽðŸŽðŸŽŒðŸ®âœ‰ï¸ðŸ“©ðŸ“¨ðŸ“§ðŸ’ŒðŸ“®ðŸ“ªðŸ“«ðŸ“¬ðŸ“­ðŸ“¦ðŸ“¯ðŸ“¥ðŸ“¤ðŸ“œðŸ“ƒðŸ“‘ðŸ“ŠðŸ“ˆðŸ“‰ðŸ“„ðŸ“…ðŸ“†ðŸ—“ðŸ“‡ðŸ—ƒðŸ—³ðŸ—„ðŸ“‹ðŸ—’ðŸ“ðŸ“‚ðŸ—‚ðŸ—žðŸ“°ðŸ““ðŸ“•ðŸ“—ðŸ“˜ðŸ“™ðŸ“”ðŸ“’ðŸ“šðŸ“–ðŸ”—ðŸ“ŽðŸ–‡âœ‚ï¸ðŸ“ðŸ“ðŸ“ŒðŸ“ðŸš©ðŸ³ðŸ´ðŸ”ðŸ”’ðŸ”“ðŸ”ðŸ–ŠðŸ–ŠðŸ–‹âœ’ï¸ðŸ“âœï¸ðŸ–ðŸ–ŒðŸ”ðŸ”Žâ¤ï¸ðŸ’›ðŸ’™ðŸ’œðŸ’”â£ðŸ’•ðŸ’žðŸ’“ðŸ’—ðŸ’–ðŸ’˜ðŸ’ðŸ’Ÿâ˜®âœâ˜ªðŸ•‰â˜¸âœ¡ðŸ”¯ðŸ•Žâ˜¯â˜¦ðŸ›â›Žâ™ˆï¸â™‰ï¸â™Šï¸â™‹ï¸â™Œï¸â™ï¸â™Žï¸â™ï¸â™ï¸â™‘ï¸â™’ï¸â™“ï¸ðŸ†”âš›ðŸˆ³ðŸˆ¹â˜¢â˜£ðŸ“´ðŸ“³ðŸˆ¶ðŸˆšï¸ðŸˆ¸ðŸˆºðŸˆ·âœ´ï¸ðŸ†šðŸ‰‘ðŸ’®ðŸ‰ãŠ™ï¸ãŠ—ï¸ðŸˆ´ðŸˆµðŸˆ²ðŸ…°ðŸ…±ðŸ†ŽðŸ†‘ðŸ…¾ðŸ†˜â›”ï¸ðŸ“›ðŸš«âŒâ­•ï¸ðŸ’¢â™¨ï¸ðŸš·ðŸš¯ðŸš³ðŸš±ðŸ”žðŸ“µâ—ï¸â•â“â”â€¼ï¸â‰ï¸ðŸ’¯ðŸ”…ðŸ”†ðŸ”±âšœã€½ï¸âš ï¸ðŸš¸ðŸ”°â™»ï¸ðŸˆ¯ï¸ðŸ’¹â‡ï¸âœ³ï¸âŽâœ…ðŸ’ ðŸŒ€âž¿ðŸŒâ“‚ï¸ðŸ§ðŸˆ‚ðŸ›‚ðŸ›ƒðŸ›„ðŸ›…â™¿ï¸ðŸš­ðŸš¾ðŸ…¿ï¸ðŸš°ðŸš¹ðŸšºðŸš¼ðŸš»ðŸš®ðŸŽ¦ðŸ“¶ðŸˆðŸ†–ðŸ†—ðŸ†™ðŸ†’ðŸ†•ðŸ†“0âƒ£1âƒ£2âƒ£3âƒ£4âƒ£5âƒ£6âƒ£7âƒ£8âƒ£9âƒ£ðŸ”ŸðŸ”¢â–¶ï¸â¸â¯â¹âºâ­â®â©âªðŸ”€ðŸ”ðŸ”‚â—€ï¸ðŸ”¼ðŸ”½â«â¬âž¡ï¸â¬…ï¸â¬†ï¸â¬‡ï¸â†—ï¸â†˜ï¸â†™ï¸â†–ï¸â†•ï¸â†”ï¸ðŸ”„â†ªï¸â†©ï¸â¤´ï¸â¤µï¸#âƒ£*âƒ£â„¹ï¸ðŸ”¤ðŸ”¡ðŸ” ðŸ”£ðŸŽµðŸŽ¶ã€°âž°âœ”ï¸ðŸ”ƒâž•âž–âž—âœ–ï¸ðŸ’²ðŸ’±Â©Â®â„¢ðŸ”šðŸ”™ðŸ”›ðŸ”ðŸ”œâ˜‘ï¸ðŸ”˜âšªï¸âš«ï¸ðŸ”´ðŸ”µðŸ”¸ðŸ”¹ðŸ”¶ðŸ”·ðŸ”ºâ–ªï¸â–«ï¸â¬›ï¸â¬œï¸ðŸ”»â—¼ï¸â—»ï¸â—¾ï¸â—½ï¸ðŸ”²ðŸ”³ðŸ”ˆðŸ”‰ðŸ”ŠðŸ”‡ðŸ“£ðŸ“¢ðŸ””ðŸ”•ðŸƒðŸ€„ï¸â™ ï¸â™£ï¸â™¥ï¸â™¦ï¸ðŸŽ´ðŸ‘â€ðŸ—¨ðŸ’­ðŸ—¯ðŸ’¬ðŸ•ðŸ•‘ðŸ•’ðŸ•“ðŸ•”ðŸ••ðŸ•–ðŸ•—ðŸ•˜ðŸ•™ðŸ•šðŸ•›ðŸ•œðŸ•ðŸ•žðŸ•ŸðŸ• ðŸ•¡ðŸ•¢ðŸ•£ðŸ•¤ðŸ•¥ðŸ•¦ðŸ•§ðŸ‡¦ðŸ‡«ðŸ‡¦ðŸ‡½ðŸ‡¦ðŸ‡±ðŸ‡©ðŸ‡¿ðŸ‡¦ðŸ‡¸ðŸ‡¦ðŸ‡©ðŸ‡¦ðŸ‡´ðŸ‡¦ðŸ‡®ðŸ‡¦ðŸ‡¶ðŸ‡¦ðŸ‡¬ðŸ‡¦ðŸ‡·ðŸ‡¦ðŸ‡²ðŸ‡¦ðŸ‡¼ðŸ‡¦ðŸ‡ºðŸ‡¦ðŸ‡¹ðŸ‡¦ðŸ‡¿ðŸ‡§ðŸ‡¸ðŸ‡§ðŸ‡­ðŸ‡§ðŸ‡©ðŸ‡§ðŸ‡§ðŸ‡§ðŸ‡¾ðŸ‡§ðŸ‡ªðŸ‡§ðŸ‡¿ðŸ‡§ðŸ‡¯ðŸ‡§ðŸ‡²ðŸ‡§ðŸ‡¹ðŸ‡§ðŸ‡´ðŸ‡§ðŸ‡¶ðŸ‡§ðŸ‡¦ðŸ‡§ðŸ‡¼ðŸ‡§ðŸ‡·ðŸ‡®ðŸ‡´ðŸ‡»ðŸ‡¬ðŸ‡§ðŸ‡³ðŸ‡§ðŸ‡¬ðŸ‡§ðŸ‡«ðŸ‡§ðŸ‡®ðŸ‡¨ðŸ‡»ðŸ‡°ðŸ‡­ðŸ‡¨ðŸ‡²ðŸ‡¨ðŸ‡¦ðŸ‡®ðŸ‡¨ðŸ‡°ðŸ‡¾ðŸ‡¨ðŸ‡«ðŸ‡¹ðŸ‡©ðŸ‡¨ðŸ‡±ðŸ‡¨ðŸ‡³ðŸ‡¨ðŸ‡½ðŸ‡¨ðŸ‡¨ðŸ‡¨ðŸ‡´ðŸ‡°ðŸ‡²ðŸ‡¨ðŸ‡¬ðŸ‡¨ðŸ‡©ðŸ‡¨ðŸ‡°ðŸ‡¨ðŸ‡·ðŸ‡­ðŸ‡·ðŸ‡¨ðŸ‡ºðŸ‡¨ðŸ‡¼ðŸ‡¨ðŸ‡¾ðŸ‡¨ðŸ‡¿ðŸ‡©ðŸ‡°ðŸ‡©ðŸ‡¯ðŸ‡©ðŸ‡²ðŸ‡©ðŸ‡´ðŸ‡ªðŸ‡¨ðŸ‡ªðŸ‡¬ðŸ‡¸ðŸ‡»ðŸ‡¬ðŸ‡¶ðŸ‡ªðŸ‡·ðŸ‡ªðŸ‡ªðŸ‡ªðŸ‡¹ðŸ‡ªðŸ‡ºðŸ‡«ðŸ‡°ðŸ‡«ðŸ‡´ðŸ‡«ðŸ‡¯ðŸ‡«ðŸ‡®ðŸ‡«ðŸ‡·ðŸ‡¬ðŸ‡«ðŸ‡µðŸ‡«ðŸ‡¹ðŸ‡«ðŸ‡¬ðŸ‡¦ðŸ‡¬ðŸ‡²ðŸ‡¬ðŸ‡ªðŸ‡©ðŸ‡ªðŸ‡¬ðŸ‡­ðŸ‡¬ðŸ‡®ðŸ‡¬ðŸ‡·ðŸ‡¬ðŸ‡±ðŸ‡¬ðŸ‡©ðŸ‡¬ðŸ‡µðŸ‡¬ðŸ‡ºðŸ‡¬ðŸ‡¹ðŸ‡¬ðŸ‡¬ðŸ‡¬ðŸ‡³ðŸ‡¬ðŸ‡¼ðŸ‡¬ðŸ‡¾ðŸ‡­ðŸ‡¹ðŸ‡­ðŸ‡³ðŸ‡­ðŸ‡°ðŸ‡­ðŸ‡ºðŸ‡®ðŸ‡¸ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡©ðŸ‡®ðŸ‡·ðŸ‡®ðŸ‡¶ðŸ‡®ðŸ‡ªðŸ‡®ðŸ‡²ðŸ‡®ðŸ‡±ðŸ‡®ðŸ‡¹ðŸ‡¨ðŸ‡®ðŸ‡¯ðŸ‡²ðŸ‡¯ðŸ‡µðŸ‡¯ðŸ‡ªðŸ‡¯ðŸ‡´ðŸ‡°ðŸ‡¿ðŸ‡°ðŸ‡ªðŸ‡°ðŸ‡®ðŸ‡½ðŸ‡°ðŸ‡°ðŸ‡¼ðŸ‡°ðŸ‡¬ðŸ‡±ðŸ‡¦ðŸ‡±ðŸ‡»ðŸ‡±ðŸ‡§ðŸ‡±ðŸ‡¸ðŸ‡±ðŸ‡·ðŸ‡±ðŸ‡¾ðŸ‡±ðŸ‡®ðŸ‡±ðŸ‡¹ðŸ‡±ðŸ‡ºðŸ‡²ðŸ‡´ðŸ‡²ðŸ‡°ðŸ‡²ðŸ‡¬ðŸ‡²ðŸ‡¼ðŸ‡²ðŸ‡¾ðŸ‡²ðŸ‡»ðŸ‡²ðŸ‡±ðŸ‡²ðŸ‡¹ðŸ‡²ðŸ‡­ðŸ‡²ðŸ‡¶ðŸ‡²ðŸ‡·ðŸ‡²ðŸ‡ºðŸ‡¾ðŸ‡¹ðŸ‡²ðŸ‡½ðŸ‡«ðŸ‡²ðŸ‡²ðŸ‡©ðŸ‡²ðŸ‡¨ðŸ‡²ðŸ‡³ðŸ‡²ðŸ‡ªðŸ‡²ðŸ‡¸ðŸ‡²ðŸ‡¦ðŸ‡²ðŸ‡¿ðŸ‡²ðŸ‡²ðŸ‡³ðŸ‡¦ðŸ‡³ðŸ‡·ðŸ‡³ðŸ‡µðŸ‡³ðŸ‡±ðŸ‡³ðŸ‡¨ðŸ‡³ðŸ‡¿ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡ªðŸ‡³ðŸ‡¬ðŸ‡³ðŸ‡ºðŸ‡³ðŸ‡«ðŸ‡²ðŸ‡µðŸ‡°ðŸ‡µðŸ‡³ðŸ‡´ðŸ‡´ðŸ‡²ðŸ‡µðŸ‡°ðŸ‡µðŸ‡¼ðŸ‡µðŸ‡¸ðŸ‡µðŸ‡¦ðŸ‡µðŸ‡¬ðŸ‡µðŸ‡¾ðŸ‡µðŸ‡ªðŸ‡µðŸ‡­ðŸ‡µðŸ‡³ðŸ‡µðŸ‡±ðŸ‡µðŸ‡¹ðŸ‡µðŸ‡·ðŸ‡¶ðŸ‡¦ðŸ‡·ðŸ‡ªðŸ‡·ðŸ‡´ðŸ‡·ðŸ‡ºðŸ‡·ðŸ‡¼ðŸ‡§ðŸ‡±ðŸ‡¸ðŸ‡­ðŸ‡°ðŸ‡³ðŸ‡±ðŸ‡¨ðŸ‡µðŸ‡²ðŸ‡»ðŸ‡¨ðŸ‡¼ðŸ‡¸ðŸ‡¸ðŸ‡²ðŸ‡¸ðŸ‡¹ðŸ‡¸ðŸ‡¦ðŸ‡¸ðŸ‡³ðŸ‡·ðŸ‡¸ðŸ‡¸ðŸ‡¨ðŸ‡¸ðŸ‡±ðŸ‡¸ðŸ‡¬ðŸ‡¸ðŸ‡½ðŸ‡¸ðŸ‡°ðŸ‡¸ðŸ‡®ðŸ‡¸ðŸ‡§ðŸ‡¸ðŸ‡´ðŸ‡¿ðŸ‡¦ðŸ‡¬ðŸ‡¸ðŸ‡°ðŸ‡·ðŸ‡¸ðŸ‡¸ðŸ‡ªðŸ‡¸ðŸ‡±ðŸ‡°ðŸ‡¸ðŸ‡©ðŸ‡¸ðŸ‡·ðŸ‡¸ðŸ‡¿ðŸ‡¸ðŸ‡ªðŸ‡¨ðŸ‡­ðŸ‡¸ðŸ‡¾ðŸ‡¹ðŸ‡¼ðŸ‡¹ðŸ‡¯ðŸ‡¹ðŸ‡¿ðŸ‡¹ðŸ‡­ðŸ‡¹ðŸ‡±ðŸ‡¹ðŸ‡¬ðŸ‡¹ðŸ‡°ðŸ‡¹ðŸ‡´ðŸ‡¹ðŸ‡¹ðŸ‡¹ðŸ‡³ðŸ‡¹ðŸ‡·ðŸ‡¹ðŸ‡²ðŸ‡¹ðŸ‡¨ðŸ‡¹ðŸ‡»ðŸ‡ºðŸ‡¬ðŸ‡ºðŸ‡¦ðŸ‡¦ðŸ‡ªðŸ‡¬ðŸ‡§ðŸ‡ºðŸ‡¸ðŸ‡»ðŸ‡®ðŸ‡ºðŸ‡¾ðŸ‡ºðŸ‡¿ðŸ‡»ðŸ‡ºðŸ‡»ðŸ‡¦ðŸ‡»ðŸ‡ªðŸ‡»ðŸ‡³ðŸ‡¼ðŸ‡«ðŸ‡ªðŸ‡­ðŸ‡¾ðŸ‡ªðŸ‡¿ðŸ‡²ðŸ‡¿ðŸ‡¼'
        if chat_id == -17279035:
            urllib.urlopen(BASE_URL + 'sendMessage', urllib.urlencode({ 'chat_id': '-17279035', 'text': random.choice(emlist) })).read()
        if chat_id == -1001005582227:
            urllib.urlopen(BASE_URL + 'sendMessage', urllib.urlencode({ 'chat_id': '-1001005582227', 'text':'ðŸ¤–' })).read()
            return
        
        def reply(msg=None, img=None):
            if msg:
                resp = urllib2.urlopen(BASE_URL + 'sendMessage', urllib.urlencode({
                    'chat_id': str(chat_id),
                    'text': msg,
                    'disable_web_page_preview': 'true',
                    'reply_to_message_id': str(message_id),
                })).read()

            logging.info('send response:')
            #logging.info(resp)





        cd = getCD(chat_id, str(chat))

        num = cd.num
        numattempts = cd.numattempts
        best = cd.best
        games = cd.games
        if cd.guesshistory:
            history = cd.guesshistory
        else:
            history = ""
        if text.startswith('/'):
            if "start" in text:
                if numattempts > 0:
                    reply("Finish the current game!!")
                else:
                    reply("Guess the 4 digit number I guessed!!")
                    numattempts = 1
                    updateCD(chat_id, num, numattempts, games, str(chat), best, history)
            elif "showbest" in text.lower():
                if best == 0:
                    reply("Start playing first :|")
                else:
                    reply("Your best was "+str(best))
            elif "history" in text:
                reply (history)
            else:
                reply('Oopsie!!')
        else:
            if numattempts > 0:
                if len(text) == SIZE and all(char in DIGITS for char in text): # and len(set(text)) == SIZE:
                    if text == num:
                      reply("You won in "+str(numattempts)+" tries!")
                      num = ''.join([random.choice(DIGITS) for _ in range(SIZE)])
                      if best == 0 or best > numattempts:
                          best = numattempts
                      numattempts = 0
                      history = ""
                      updateCD(chat_id, num, numattempts, games+1, str(chat), best, history)
                      return
                    numattempts += 1
                    bulls = cows = 0
                    for i in range(SIZE):
                      if text[i] == num[i]:
                          bulls += 1
                    for i in range(len(set(text))):
                      if "".join(set(text))[i] in num:
                         cows += 1
                    cows = cows - bulls
                    try:
                        history+="#"+str(numattempts-1)+". "+text+"\nBulls: "+str(bulls)+"\nCows: "+str(cows)+"\n\n"
                    except:
                        history = ""
                    reply("Attempt: "+str(numattempts-1)+"\nBulls: "+str(bulls)+"\nCows: "+str(cows))
                    updateCD(chat_id, num, numattempts, games, str(chat), best, history)
                    return
                reply("4 DIGITS!!!")
            else:
                reply("Click /start")


app = webapp2.WSGIApplication([
    ('/me', MeHandler),
    ('/updates', GetUpdatesHandler),
    ('/set_webhook', SetWebhookHandler),
    ('/webhook', WebhookHandler),
    ('/test', MeTester),
], debug=True)
